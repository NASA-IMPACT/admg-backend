{% extends "api_app/base.html" %}
{% load change_extras crispy_forms_tags static %}

{% block extrahead %}
{{ block.super }}
{{ form.media }}
{{ model_form.media }}
{% endblock %}

{% block page %}
<div class="row">
  {# Main Content #}
  <div class="col-8">
    <h3>{{ object.model_name }}: {{ object.update.short_name | default:object.uuid }}
    </h3>
    <table class="table table-responsive">
      <form method="post" id="model-form">
        {% csrf_token %}
        {% for field in form %} {{ field.as_hidden }} {% endfor %}
        {{ model_form | crispy }}
      </form>

    </table>
  </div>

  {# Sidebar #}
  <div class="col-4">
    <h3>Draft Details</h3>
    <dl>
      <dt>Item Type:</dt>
      <dd>{{ object.model_name }}</dd>
      <dt>Action:</dt>
      <dd>{{ object.get_action_display }}</dd>
      <dt>Status:</dt>
      <dd>{{ object.get_status_display }}</dd>
    </dl>

    <h3>Actions</h3>
    <button form="model-form" class="btn btn-primary">Save</button>

    <button class="btn btn-secondary dropdown-toggle" type="button" data-toggle="dropdown" aria-haspopup="true"
      aria-expanded="false">Approval Actions
    </button>

    <div class="dropdown-menu">
      <form action="{% url 'change-transition' object.uuid %}" method="post" class="px-4 py-3">
        {% csrf_token %}
        {{ transition_form | crispy }}
        <button class="btn btn-primary">Submit</button>
      </form>
    </div>

    <h5>Update status</h5>

    <h3>Related Data</h3>
    {% related_changes change %}

    <hr />

    <h3>History</h3>
    {% related_approval_logs approvals %}

    <hr />

    <h3>Raw Data</h3>
    {{ form.errors }}
    <code>{{ object.update | pprint }}</code>
  </div>
</div>

{% endblock %}

{% block javascript %}
{{ block.super }}
<script>
  // Mark all required inputs as not-required (but store required as data-required attribute)
  ['input', 'textarea', 'select'].forEach(function (value) {
    $(value + '[required]')
      .attr('data-required', true)
      .attr('required', false);
  })

  // Make dropdown more resistant to accidental closes (https://stackoverflow.com/a/32922725/728583)
  $(document).on('click', '.dropdown-menu', function (e) {
    e.stopPropagation();
  });
</script>
{% endblock %}