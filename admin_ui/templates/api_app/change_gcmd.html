{% extends "api_app/base_read.html" %}
{% load static %}
{% load model_helpers %}
{% load humanize %}

{% block header %}
  <div class="col">
    {% include 'snippets/breadcrumbs.html' with ancestors=ancestors %}

    <a href="{% spaceless %}
        {% if "back" in request.GET %} {{ request.GET.back }}
        {% else %}{% url back_button %}
        {% endif %}
        {% endspaceless %}">
      &larr; Back
    </a>
    {% if object.content_type.model == 'website' %}
    <h1>{{ object.update.title | default:object.uuid }}</h1>
    {% else %}
    <h1>{{ object.update.short_name | default:object.uuid }}</h1>
    {% endif %}
  </div>
{% endblock header %}

{% block actions %}
  <div class="px-1">
    {% include "snippets/approval_dropdown.html" %}
  </div>

  <div class="px-1">
    <button 
      class="btn btn-primary" 
      form="model-form" 
      formnovalidate
      {% if disable_save %}disabled{% endif %}
    >
      Save
    </button>
    <button 
      class="btn btn-secondary" 
      form="model-form" 
      name="_validate"
    >
      Validate
    </button>
  </div>
{% endblock actions %}

{% block main %}
  {% with main_class="col-lg-8" %}
    {{ block.super }}
  {% endwith %}
  
  {# Sidebar #}
  <aside class="col col-lg-4">
    <!-- {% if object.update.logo %}
    <h3>Logo</h3>
    <a href="{% url 'change-update' object.update.logo %}">
      {% if object.logo_path %}
      <img class="img-thumbnail" src="{{ object.logo_path | get_full_url }}" />
      {% else %}
      <span class="font-italic">(logo missing image)</span>
      {% endif %}
    </a> -->

    <!-- <hr />
    {% endif %} -->

    <h3>Activity</h3>
    {% include 'snippets/related_approval_logs.html' with approval_logs=object.approvallog_set.all show_notes=True%}

    <hr />

    <details class="small">
      <summary>Debug Data</summary>

      <pre>{{ object.update | pprint }}</pre>
    </details>

  </aside>
{% endblock main%}

{% block form %}
<br>
<!-- New Path -->
<p class="gcmd-label">New Path</p>
<p class="gcmd-path">
    {% for attribute in gcmd_path.path %}
        <span style="color:{% if attribute.has_changed %} #D6311C {% else %} black {% endif %};">{{attribute.new_value}}</span>
        {% if not forloop.last %} <span style="color: black;"> > </span> {% endif %}
    {% endfor %}
</p>
<p class="gcmd-footer">
    {% for attribute in gcmd_path.path %}
        <span style="color:{% if attribute.has_changed %} #D6311C {% else %} rgba(68, 63, 63, 0.64) {% endif %};">{{attribute.key}}</span>
        {% if not forloop.last %} <span style="color: black;"> > </span> {% endif %}
    {% endfor %}
</p>
<!-- Old Path -->
{% if gcmd_path.old_path %}
    <p class="gcmd-label">Old Path</p>
    <p class="gcmd-path">
        {% for attribute in gcmd_path.path %}
            <span style="color:{% if attribute.has_changed %} #D6311C {% else %} black {% endif %};">{{attribute.old_value}}</span>
            {% if not forloop.last %} <span style="color: black;"> > </span> {% endif %}
        {% endfor %}
    </p>
    <p class="gcmd-footer">
        {% for attribute in gcmd_path.path %}
            <span style="color:{% if attribute.has_changed %} #D6311C {% else %} rgba(68, 63, 63, 0.64) {% endif %};">{{attribute.key}}</span>
            {% if not forloop.last %} <span style="color: black;"> > </span> {% endif %}
        {% endfor %}
    </p>
{% endif %}
<hr style="height:2px;border-width:0;color:gray;background-color:gray">
<p class="gcmd-label">Recommended GCMD Keyword Changes</p>
<p>We have found {{affected_records | length }} potentially affected record(s)</p>
<ol>
    <li>First, make sure this GCMD keyword is published before reviewing affected records.</li>
    <li>Adding this GCMD keyword to an affected record will automatically remove it from the table below.</li>
    <li>If no changes are required, you can manually "Mark as Reviewed" to remove the item from the list below.</li>
</ol>
    {% if affected_records %}
        <form action="{% url 'change-gcmd' object.uuid %}" method="post">
            <table class="affected-table">
                <tr class="affected-row">
                    <th>Affected Record</th>
                    <th>Category</th>
                    <th>Status</th>
                    <th>Previously Associated</th>
                    <th>Associate With Keyword</th>
                </tr>
                {% for record in affected_records %}
                    <tr>
                        <!-- TODO: href should follow {% url 'some-url-name' arg arg2 as the_url %} -->
                            <td><a href="{{record.link}}">{{record.row.short_name}}</a></td>
                        </a>
                        <td>{{record.category}}</td>
                        <td>{{record.status}}</td>
                        <td>{{record.is_connected}}</td>
                        <td>
                            {% csrf_token %}
                            <!-- <input type="radio" id="ignoreChoice" checked="{{record.currentSelection.ignore}}"> -->
                            <input type="radio" id="connectChoice" name="choice-{{record.row.uuid}}" value="True" "{% if record.currentSelection.connect %} checked {% else %} {% endif %};">
                            <label for="connectChoice" class="review-button">Yes</button>
                            <!-- <input type="radio" id="connectChoice" checked="{{record.currentSelection.connect}}"> -->
                            <input type="radio" id="ignoreChoice" name="choice-{{record.row.uuid}}" value="False" "{% if record.currentSelection.ignore %} checked {% else %} {% endif %};">
                            <label for="ignoreChoice" class="review-button">No</button>
                        </td>
                        <!-- <form action="{% url 'change-gcmd' object.uuid %}" method="post">
                            {% csrf_token %}
                            <input type="hidden" name="related_uuid" value="{{record.row.uuid}}">
                            <button class="review-button">Mark Reviewed</button>
                        </form> -->
                        <!-- <td><button class="review-button">Mark Reviewed</button></td> -->
                    </tr>
                    <br>
                {% endfor %}
            </table>
            {% with affected_records|last as last %}
                <input type="hidden" name="related_uuids" value="{{last.uuids}}">
                <label for="related_uuids" class="review-button"></label>
            {% endwith %}

            <input type="submit" id="saveButton" name="user_button" value="Save">
            <!-- <label for="saveButton" class="review-button">Save</label> -->
            <input type="submit" id="doneButton" name="user_button" value="Done">
            <!-- <label for="doneButton" class="review-button">Done</label> -->

            <!-- <input type="hidden" name="save_button">
            <button name="saveButton" value="save" class="review-button">Save</button>
            <input type="hidden" name="done_button">
            <button name="doneButton" value="done" class="review-button">Done</button> -->
        </form>
    {% endif %}
{% endblock form %}
